import{a as h}from"./chunk-TZMPXKHX.js";import{V as l,_ as g,i as o,n as u,z as m}from"./chunk-JKZ4R3JY.js";var y=class d{complaintsApi=g(h);fallbackPage(e,t){return{data:[],pagination:{page:e,pageSize:t,totalItems:0,totalPages:1}}}getInquiries(e={}){let t=e.page??1,n=e.pageSize??20,r=this.normalizeStatusParam(e.status),a=e.channel&&e.channel!=="all"?e.channel:void 0;return this.complaintsApi.apiComplaintsGet(r,a,t,n).pipe(u(i=>this.mapComplaintPage(i,t,n,e.searchQuery)),m(()=>o(this.fallbackPage(t,n))))}getInquiryById(e){return this.complaintsApi.apiComplaintsComplaintIdGet(e).pipe(u(t=>this.mapComplaintToInquiry(t)??this.createUnknownInquiry(e)),m(()=>o(this.createUnknownInquiry(e))))}updateInquiryStatus(e,t){let n={status:t};return this.complaintsApi.apiComplaintsComplaintIdPatch(e,n).pipe(u(r=>this.mapComplaintToInquiry(r)??this.createUnknownInquiry(e)),m(()=>o(this.createUnknownInquiry(e))))}assignInquiry(e,t){let n={assignedTo:t};return this.complaintsApi.apiComplaintsComplaintIdPatch(e,n).pipe(u(r=>this.mapComplaintToInquiry(r)??this.createUnknownInquiry(e)),m(()=>o(this.createUnknownInquiry(e))))}sendMessage(e,t){let n={resolution:t};return this.complaintsApi.apiComplaintsComplaintIdPatch(e,n).pipe(u(()=>{}),m(()=>o(void 0)))}markAsRead(e){let t={status:"in-progress"};return this.complaintsApi.apiComplaintsComplaintIdPatch(e,t).pipe(u(()=>{}),m(()=>o(void 0)))}mapComplaintPage(e,t,n,r){let i=this.extractArray(e).map(s=>this.mapComplaintToInquiry(s)).filter(s=>s!==null),p=r?i.filter(s=>this.matchesSearch(s,r)):i,c=this.extractPagination(e,t,n,p.length);return{data:p,pagination:c}}mapComplaintToInquiry(e){if(!this.isRecord(e))return null;let t=this.readString(e,["id","complaintId","reference","trackingNumber"],crypto.randomUUID()),n=this.normalizeChannel(this.readString(e,["channel","type","source"],"api")),r=this.normalizeStatus(this.readString(e,["status","state"],"open")),a=this.normalizePriority(this.readString(e,["priority","priorityLevel"],"medium")),i=this.readDate(e,["createdAt","created_at","timestamp"])??new Date,p=this.readDate(e,["updatedAt","updated_at","lastUpdated"])??i,c=this.extractArray(e.messages).map(s=>this.mapMessage(s));return{id:t,customerName:this.readString(e,["customerName","name","customer","fullName"],"Unknown Customer"),customerPhone:this.readString(e,["customerPhone","phone","contact"],"N/A"),channel:n,status:r,priority:a,subject:this.readString(e,["subject","title","reason"],"Customer Inquiry"),messagePreview:this.readString(e,["messagePreview","message","summary","description","latestMessage"],"No message available"),messages:c,assignedTo:this.readString(e,["assignedTo","assignee"],""),createdAt:i,updatedAt:p}}mapMessage(e){return this.isRecord(e)?{id:this.readString(e,["id","messageId"],crypto.randomUUID()),sender:this.normalizeSender(this.readString(e,["sender","from"],"system")),content:this.readString(e,["content","message","body"],"Message unavailable"),timestamp:this.readDate(e,["timestamp","createdAt","time"])??new Date,read:this.readBoolean(e,["read","isRead"],!0)}:{id:crypto.randomUUID(),sender:"system",content:"Message unavailable",timestamp:new Date,read:!0}}createUnknownInquiry(e){return{id:e,customerName:"Unknown Customer",customerPhone:"N/A",channel:"api",status:"open",priority:"medium",subject:"Customer Inquiry",messagePreview:"No details available",messages:[],createdAt:new Date,updatedAt:new Date}}extractPagination(e,t,n,r){if(!this.isRecord(e))return this.buildPagination(t,n,r);let a=this.isRecord(e.pagination)?e.pagination:this.isRecord(e.meta)?e.meta:e;if(!this.isRecord(a))return this.buildPagination(t,n,r);let i=this.readNumber(a,["totalItems","total","count"],r),p=this.readNumber(a,["page","currentPage"],t),c=this.readNumber(a,["pageSize","perPage"],n),s=this.readNumber(a,["totalPages","pages"],Math.max(1,Math.ceil(i/c)));return{page:p,pageSize:c,totalItems:i,totalPages:s}}buildPagination(e,t,n){return{page:e,pageSize:t,totalItems:n,totalPages:Math.max(1,Math.ceil(n/t))}}extractArray(e){if(Array.isArray(e))return e;if(this.isRecord(e)){let n=[e.data,e.items,e.results].find(r=>Array.isArray(r));return Array.isArray(n)?n:[]}return[]}matchesSearch(e,t){let n=t.toLowerCase();return e.customerName.toLowerCase().includes(n)||e.id.toLowerCase().includes(n)||e.messagePreview.toLowerCase().includes(n)}normalizeChannel(e){let t=e.toLowerCase();return t.includes("whatsapp")?"whatsapp":t.includes("telegram")?"telegram":t.includes("widget")?"widget":"api"}normalizeSender(e){let t=e.toLowerCase();return t.includes("customer")?"customer":t.includes("agent")?"agent":"system"}normalizeStatus(e){let t=e.toLowerCase().replace(/_/g,"-");return t.includes("pending")?"pending":t.includes("resolved")?"resolved":t.includes("closed")?"closed":t.includes("in-progress")||t.includes("inprogress")?"in-progress":"open"}normalizeStatusParam(e){if(!(!e||e==="all"))return e==="in-progress"?"in_progress":e}normalizePriority(e){let t=e.toLowerCase();return t.includes("urgent")?"urgent":t.includes("high")?"high":t.includes("low")?"low":"medium"}readNumber(e,t,n){for(let r of t){let a=e[r];if(typeof a=="number"&&Number.isFinite(a))return a;if(typeof a=="string"&&a.trim()!==""&&!Number.isNaN(Number(a)))return Number(a)}return n}readString(e,t,n){for(let r of t){let a=e[r];if(typeof a=="string"&&a.trim()!=="")return a}return n}readDate(e,t){for(let n of t){let r=e[n];if(r instanceof Date)return r;if(typeof r=="string"||typeof r=="number"){let a=new Date(r);if(!Number.isNaN(a.getTime()))return a}}return null}readBoolean(e,t,n){for(let r of t){let a=e[r];if(typeof a=="boolean")return a}return n}isRecord(e){return typeof e=="object"&&e!==null}static \u0275fac=function(t){return new(t||d)};static \u0275prov=l({token:d,factory:d.\u0275fac,providedIn:"root"})};export{y as a};
