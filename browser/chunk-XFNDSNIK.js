import{a as v}from"./chunk-QRB52CVI.js";import{a as g}from"./chunk-GFU3UW6A.js";import{a as f}from"./chunk-ZYQ7KRKH.js";import{a as S}from"./chunk-OFIQSEYL.js";import{E as c,V as u,_ as d,i as p,n as s,oa as h,z as m}from"./chunk-JKZ4R3JY.js";var b=class o{shipmentsApi=d(S);getShipments(e={}){let t=e.page||1,n=e.pageSize||10,r=e.status!=="all"?e.status:void 0;return this.shipmentsApi.apiShipmentsGet(t,n,r).pipe(s(i=>this.mapShipmentPage(i,t,n)),m(()=>p(this.getMockPaginatedShipments(e))),c(200))}getShipmentById(e){return this.getShipmentByTracking(e)}getShipmentByTracking(e){return this.shipmentsApi.apiShipmentsTrackingTrackingNumberGet(e).pipe(s(t=>this.mapShipmentResponse(t)??this.getMockShipment(e)),m(()=>p(this.getMockShipment(e))),c(200))}createShipment(e){return this.shipmentsApi.apiShipmentsPost(e).pipe(s(t=>this.mapShipmentResponse(t)??this.getMockShipment("new")),m(()=>p(this.getMockShipment("new"))),c(400))}updateStatus(e,t,n,r){return this.shipmentsApi.apiShipmentsTrackingTrackingNumberStatusPatch(e,{status:t,location:n,notes:r}).pipe(s(i=>this.mapShipmentResponse(i)??this.getMockShipment(e)),m(()=>p(this.getMockShipment(e))),c(300))}bulkUpdateStatus(e,t){return p(void 0).pipe(c(800))}deleteShipment(e){return p(void 0).pipe(c(500))}mapShipmentPage(e,t,n){let r=(e.data??[]).map(a=>this.mapShipmentResponse(a)).filter(a=>a!==null),i=e.pagination?.totalItems??r.length;return{data:r,total:i,page:e.pagination?.page??t,pageSize:e.pagination?.pageSize??n}}mapShipmentResponse(e){if(!e)return null;let t=this.mapAddress(e.sender),n=this.mapAddress(e.receiver),r=e.createdAt?new Date(e.createdAt):new Date,i=e.estimatedDelivery?new Date(e.estimatedDelivery):new Date;return{id:e.id??e.trackingNumber??crypto.randomUUID(),trackingNumber:e.trackingNumber??"N/A",origin:t,destination:n,serviceType:this.normalizeServiceType(e.serviceType),weight:e.parcel?.weight??0,cost:e.parcel?.value??0,status:this.normalizeStatus(e.status),statusLabel:e.status??void 0,eta:i,customerName:e.receiver?.name??"Unknown Customer",customerPhone:e.receiver?.phone??"N/A",createdAt:r,updatedAt:r,timeline:[],senderName:e.sender?.name??void 0,senderPhone:e.sender?.phone??void 0,senderEmail:e.sender?.email??null,receiverName:e.receiver?.name??void 0,receiverPhone:e.receiver?.phone??void 0,receiverEmail:e.receiver?.email??null,parcelDescription:e.parcel?.description??null,parcelLength:e.parcel?.length??null,parcelWidth:e.parcel?.width??null,parcelHeight:e.parcel?.height??null,parcelValue:e.parcel?.value??null}}mapAddress(e){return{street:e?.address??"Unknown",city:e?.city??"Unknown",state:"",postalCode:"",country:e?.country??"Unknown"}}normalizeServiceType(e){let t=e?.toLowerCase()??"standard";return t.includes("express")?"Express":t.includes("overnight")?"Overnight":"Standard"}normalizeStatus(e){let t=e?.toLowerCase()?.replace(/_/g,"-")??"pending";return t.includes("picked")?"picked-up":t.includes("in-transit")||t.includes("transit")?"in-transit":t.includes("out-for-delivery")||t.includes("out")?"out-for-delivery":t.includes("delivered")?"delivered":t.includes("delayed")?"delayed":t.includes("cancelled")||t.includes("canceled")?"cancelled":"pending"}getMockPaginatedShipments(e){let t=e.page??1,n=e.pageSize??10,r=(t-1)*n;return{data:Array.from({length:n},(a,l)=>this.getMockShipment(`mock-${r+l+1}`)),total:n*5,page:t,pageSize:n}}getMockShipment(e){return{id:e,trackingNumber:`LOOM-${Math.floor(Math.random()*1e5)}`,origin:{street:"100 Market St",city:"San Francisco",state:"CA",postalCode:"94103",country:"USA"},destination:{street:"500 5th Ave",city:"New York",state:"NY",postalCode:"10018",country:"USA"},serviceType:"Express",weight:2.5,cost:25,status:"in-transit",eta:new Date(Date.now()+1e3*60*60*24*2),customerName:"John Doe",customerPhone:"555-0100",createdAt:new Date(Date.now()-1e3*60*60*24),updatedAt:new Date,timeline:[{status:"pending",location:"San Francisco, CA",timestamp:new Date(Date.now()-1e3*60*60*24),notes:"Shipment created"},{status:"picked-up",location:"San Francisco, CA",timestamp:new Date(Date.now()-1e3*60*60*20),notes:"Package picked up"},{status:"in-transit",location:"Denver, CO",timestamp:new Date(Date.now()-1e3*60*60*12),notes:"In transit to destination"}]}}static \u0275fac=function(t){return new(t||o)};static \u0275prov=u({token:o,factory:o.\u0275fac,providedIn:"root"})};var w=class o{dashboardApi=d(f);getMetrics(){return this.dashboardApi.apiDashboardOverviewGet().pipe(s(e=>this.mapOverviewToMetrics(e)))}getShipmentVolume(e=7){let t=this.mapPeriod(e);return this.dashboardApi.apiDashboardShipmentsStatsGet(t).pipe(s(n=>this.mapTimeSeries(n,e)))}getInquiryVolume(e=7){let t=this.mapPeriod(e);return this.dashboardApi.apiDashboardComplaintsStatsGet(t).pipe(s(n=>this.mapTimeSeries(n,e)))}getInquiryPurposeBreakdown(){return this.dashboardApi.apiDashboardComplaintsStatsGet("month").pipe(s(e=>this.mapPurposeBreakdown(e)))}getRecentActivity(e=10){return this.dashboardApi.apiDashboardOverviewGet().pipe(s(t=>this.mapRecentActivity(t,e)))}getUrgentInquiries(){return this.dashboardApi.apiDashboardComplaintsStatsGet("week").pipe(s(e=>this.isRecord(e)&&typeof e.open=="number"?{open:e.open}:{open:0}))}mapOverviewToMetrics(e){if(!this.isRecord(e))throw new Error("Invalid API response for dashboard metrics");return{totalShipments:this.readNumber(e,["totalShipments"],0),deliveredToday:0,pendingShipments:this.readNumber(e,["activeShipments"],0),onTimeDeliveryRate:this.readNumber(e,["deliveryRate"],0),totalRevenue:this.readNumber(e,["totalRevenue"],0),activeDrivers:0,totalInquiries:this.readNumber(e,["openComplaints"],0),inquiriesHandledToday:0,inquiryResolutionRate:0,trends:{shipments:0,revenue:0,deliveryRate:0,inquiries:0}}}mapTimeSeries(e,t){let n=this.extractArray(e);return n.length?n.map(i=>{if(!this.isRecord(i))return null;let a=this.readDate(i,["date","day","timestamp"]),l=this.readNumber(i,["count","total","value"],void 0);return!a||l===void 0?null:{date:a,count:l}}).filter(i=>i!==null):[]}mapPurposeBreakdown(e){let t=this.extractArray(e);return t.length?t.map(r=>{if(!this.isRecord(r))return null;let i=this.readString(r,["purpose","type","label","category","status"],"Other"),a=this.readNumber(r,["count","total","value"],void 0);return a===void 0?null:{purpose:i,count:a}}).filter(r=>r!==null):[]}mapRecentActivity(e,t){if(!this.isRecord(e))return[];let n=this.extractArray(e.recentActivity??e.recentActivities??e.activities);return n.length?n.map(i=>{if(!this.isRecord(i))return null;let a=this.readDate(i,["timestamp","createdAt","time"]);return a?{id:this.readString(i,["id","activityId"],crypto.randomUUID()),type:this.readString(i,["type"],"inquiry"),title:this.readString(i,["title","trackingNumber","reference"],"Activity"),description:this.readString(i,["description","customer","summary"],"Recent activity"),timestamp:a,status:this.readString(i,["status"],"open")}:null}).filter(i=>i!==null).slice(0,t):[]}mapPeriod(e){return e<=7?"week":e<=30?"month":e<=90?"quarter":"year"}extractArray(e){if(Array.isArray(e))return e;if(this.isRecord(e)){let n=[e.data,e.items,e.results].find(r=>Array.isArray(r));return Array.isArray(n)?n:[]}return[]}readNumber(e,t,n){for(let r of t){let i=e[r];if(typeof i=="number"&&Number.isFinite(i))return i;if(typeof i=="string"&&i.trim()!==""&&!Number.isNaN(Number(i)))return Number(i)}return n??0}readString(e,t,n){for(let r of t){let i=e[r];if(typeof i=="string"&&i.trim()!=="")return i}return n}readDate(e,t){for(let n of t){let r=e[n];if(r instanceof Date)return r;if(typeof r=="string"||typeof r=="number"){let i=new Date(r);if(!Number.isNaN(i.getTime()))return i}}return null}isRecord(e){return typeof e=="object"&&e!==null}static \u0275fac=function(t){return new(t||o)};static \u0275prov=u({token:o,factory:o.\u0275fac,providedIn:"root"})};var k=class o{authService=d(v);ws=null;connected=h(!1);messages=h([]);connect(){if(this.ws?.readyState===WebSocket.OPEN)return;let e=this.authService.getApiKey();if(!e){console.error("Cannot connect to WebSocket: No API key");return}this.ws=new WebSocket(`${g.wsUrl}?apiKey=${e}`),this.ws.onopen=()=>{this.connected.set(!0),console.log("WebSocket connected")},this.ws.onmessage=t=>{let n=JSON.parse(t.data);this.messages.update(r=>[...r,n])},this.ws.onerror=t=>{console.error("WebSocket error:",t)},this.ws.onclose=()=>{this.connected.set(!1),console.log("WebSocket disconnected"),setTimeout(()=>this.connect(),5e3)}}disconnect(){this.ws&&(this.ws.close(),this.ws=null,this.connected.set(!1))}send(e){this.ws?.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify(e)):console.error("WebSocket is not connected")}static \u0275fac=function(t){return new(t||o)};static \u0275prov=u({token:o,factory:o.\u0275fac,providedIn:"root"})};export{b as a,w as b};
